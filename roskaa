
#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <avr/wdt.h>

const int red=PB0;
const int ser=PB1;
const int trig=PB3;
const int echo=PB4;


#include <Servo.h>

Servo myServo;  // Create a Servo object

void setup() {
  pinMode(red, OUTPUT);
  pinMode(ser, OUTPUT);
  pinMode(trig, OUTPUT);
  pinMode(echo, INPUT);
  myServo.attach(ser);  // Attach the servo to pin 0 (PB0)}
  digitalWrite(red, HIGH);
  myServo.write(1);
  delay(1000);
  myServo.write(90);
  delay(1000);
  digitalWrite(red, LOW); 
}

int sample() {
  digitalWrite(trig, LOW);
  delayMicroseconds(10);
  digitalWrite(trig, HIGH);
  delayMicroseconds(10);
  digitalWrite(trig, LOW);
  return(90-pulseIn(echo, HIGH)/300);
}

int sample10 (){
  digitalWrite(red, HIGH);
  const int kpl=20;
  int k=0;
  for (int i=0;i<kpl;i++) k=k+sample();
  digitalWrite(red, LOW); 
  return(k/kpl);
}

void loop() {
  int duration = sample10();
  if (duration>0){
    myServo.write(duration);
    delay(15);
  }
  else {
    myServo.write(0);
    delay(15);
  }
}
